<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-image/iron-image.html">


<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../warp10-tiles/warp10-dashboard-styles.html">
<link rel="import" href="../warp10-tiles/warp10-dashboard-tile.html">
<link rel="import" href="../warp10-tiles/warp10-display-behavior.html">

<dom-module is="warp10-switch-boolean">
  <template>    
    <style include="warp10-dashboard-styles">
      :host {
        display: inline-block;
      }
      .horizontal {
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .vertical {
        height: 100%;
        @apply(--layout-vertical);
        @apply(--layout-center);
        @apply(--layout-around-justified);
      }
      #booleanIcon {
        --iron-icon-height: 64px;
        --iron-icon-width: 64px;
      }
      #imageIcon {
        width: 64px;
        height: 64px;
      }
      .switchbar iron-icon {
        --iron-icon-height: 18px;
        --iron-icon-width: 18px;
        margin-right: 5px;
      }
      #switch {
        --paper-toggle-button-checked-bar-color: 	#000000;
        --paper-toggle-button-checked-button-color: var(--paper-grey-50);
        --paper-toggle-button-checked-ink-color: var(--dark-primary-color);

      }
    </style>

    <iron-ajax 
        id="service"
        url="{{url}}"
        handle-as="json"
        method='POST'
        on-response="_handleServiceResponse"
        on-error="_handleServiceError"
        debounce-duration="300"></iron-ajax>

    <warp10-dashboard-tile 
        tile="{{tile}}" description="[[description]]"
        width="{{width}}" height="{{height}}"
        bg-color="{{bgColor}}" fg-color="{{fgColor}}">
      <div class="card-content">
        <div class="main-content">        
          <div class="vertical">
            <div id="value" class="value">
              <template is="dom-if" if="{{!useExternalImages}}">
                <iron-icon id="booleanIcon" icon="{{_iconName}}"></iron-icon>  
              </template> 
              <template is="dom-if" if="{{useExternalImages}}">
                <iron-image id="imageIcon" src="{{_iconName}}" sizing="contain"></iron-image>
              </template>
            </div>
            <div class="horizontal switchbar">
              <template is="dom-if" if="{{!useExternalImages}}">
                <iron-icon icon="{{iconForFalse}}"></iron-icon>
              </template>
              <paper-toggle-button
                  id="switch"
                  disabled="{{_disabled}}"
                  on-change="_callService"></paper-toggle-button>
              <template is="dom-if" if="{{!useExternalImages}}">
                <iron-icon icon="{{iconForTrue}}"></iron-icon>
              </template>
            </div>
          </div>
        </div>
        <div class="label">[[label]]</div>
      </div>     
    </warp10-dashboard-tile>  

  </template>
  <script>
    Polymer({
      // Element identity
      is:"warp10-switch-boolean",
      
      behaviors: [ Warp10DisplayBehavior ],
      
      // Properties
      properties: {       
            
        /**
         * The data to display
         */
        data: {
          type: Boolean,
          value: false,
        },
        
        /**
         * Icon to show when the value est true
         */
        iconForTrue: {
          type: String,
          value: "check"
        },
        /**
         * Icon to show when the value est true
         */
        iconForFalse: {
          type: String,
          value: "clear"
        },

        useExternalImages:{
          type: Boolean,
          value: false
        },

        /**
         * Switch service url
         */
        url: {
          type: String,
          value: "./service"
        },

        /**
         *
         */
        _isReady: {
          type: Boolean,
          value: false
        },
        /**
         *
         */
        _iconName: {
          type: String,
          computed: "_getIconName(data, _isReady)"
        },
        /** 
         * 
         */
        _sendingMode: {
          type: Boolean,
          value: false
        },
        /** 
         * 
         */
        _waitingForResultMode: {
          type: Boolean,
          value: false
        },
        /**
         * 
         */
        _disabled: {
          type: Boolean,
          computed: "_isDisabled(_sendingMode,_waitingForResultMode)"
        }
      },

      observers: [
        "_onValueChange(data,_sendingMode,_waitingForResultMode)"
      ],

      // Livecycle
      ready: function() {
        this._isReady = true;
      },
      
      // Computed properties' methods
      _getIconName: function() {
        // console.debug("[warp10-switch-boolean] _getIconName", this.data, this.iconForTrue, this.iconForFalse);
        if (this.data) {
          return this.iconForTrue;
        } else {
          return this.iconForFalse;
        }
      },

      
      // **********************************************************************
      // Observers
      // **********************************************************************
      _onValueChange: function() {
        if (!this._disabled) {
          this.$.switch.checked = this.data;
          return;
        }
        if (this._waitingForResultMode) {
          if (this.$.switch.checked == this.data) {
            this._waitingForResultMode = false;
          }
        } 
      },
      _isDisabled: function() {
        return (this._sendingMode || this._waitingForResultMode);
      },

      // **********************************************************************
      // Action listener
      // **********************************************************************
      _callService: function(evt) {
        evt.stopPropagation();
        this._sendingMode = true;
        this.$.service.body = '{"value":' + this.$.switch.active + '}';
        this.$.service.generateRequest();
      },

      // **********************************************************************
      // Event Handlers
      // **********************************************************************
      _handleServiceResponse: function(evt, request) {
        evt.stopPropagation();
        this._waitingForResultMode = true; 
        this._sendingMode = false;
        console.debug("[warp10-switch-boolean] _handleServiceResponse", request.response);
        this.fire('service-response', response);        
      },
      _handleServiceError: function(evt, error) {
        evt.stopPropagation();
        this._waitingForResultMode = false; 
        this._sendingMode = false;
        console.debug("[warp10-switch-boolean] _handleServiceError", error);
        this.fire('service-error', error);
      },
      
    });
  </script>
</dom-module>