<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href="../warp10-tiles/warp10-dashboard-styles.html">
<link rel="import" href="../warp10-tiles/warp10-dashboard-tile.html">
<link rel="import" href="../warp10-tiles/warp10-tile-behavior.html">
<link rel="import" href="../warp10-quantumviz/warp10-display-alt-chart.html">

<dom-module is="warp10-display-sparkline">
  <template>    
    <style include="warp10-dashboard-styles" is="custom-style" >
      :host {
        display: inline-block;
      }
      .value-bounds {
        position: absolute;
        bottom: 0; 
        left: 0;
        width: 100%;
        background-color: rgba(128,128,128,0.8);
      }
      .value-bounds[hidden] {
        display: none;
      }
      .value-bounds-close {
        float:right;
        padding: 5px;        
      }
      .value-bounds-close::before {
        content: " "
      }
      .value-bounds-content {
        display: flex;
        flex-flow: row;
        justify-content: space-around;
        padding: 5px;
      } 
    </style>
    <warp10-dashboard-tile 
      tile="{{tile}}" height="{{height}}" width="{{width}}"
      bg-color="{{bgColor}}" fg-color="{{fgColor}}" description="{{description}}"
    >    
      <div class="card-content">
        <div class="main-content">    
          <warp10-display-chart
            height="{{usefulHeight}}" width="{{usefulWidth}}"
            id="warp10-display-chart" value-bounds="{{valueBounds}}"
            data={{data}}
            line-width="0.75"
            current-values="{{_currentValues}}"
            hide-axis hide-tooltip
            on-mouseenter="_mouseEnter" 
            on-mouseleave="_mouseLeave"
            ></warp10-display-chart>
        </div>
        <div class="label">[[label]] </div>
      </div>     
      
      <div class="value-bounds" hidden="{{_hideValueBounds}}">
        <div class="value-bounds-close" on-click="_closeValueBounds"></div>
        <div class="value-bounds-content">
          <template is="dom-if" if="{{_hasNLines(_currentValues,1)}}">
              {{_getName(_currentValues,0)}}: {{_getValue(_currentValues,0)}} <br>   
          </template>
          <template is="dom-if" if="{{_hasNLines(_currentValues,2)}}">
            <div>
              {{_getName(_currentValues,0)}}: {{_getValue(_currentValues,0)}} <br>            
              {{_getName(_currentValues,1)}}: {{_getValue(_currentValues,1)}}
            </div> 
          </template>
          <template is="dom-if" if="{{_hasMoreThanNLines(_currentValues,2)}}">
            <div>
              max: {{_maxValue(_currentValues)}} <br>            
              min: {{_minValue(_currentValues)}}
            </div> 
          </template>
        </div>
      </div>
        
      
    </warp10-dashboard-tile>
  </template>
  <script>
    Polymer({
      // Element identity
      is:"warp10-display-sparkline",
      
      behaviors: [ Warp10TileBehavior ],
      
      // Properties
      properties: {
        
        /**
         * The data to display
         */
        data: {
          type: Array,
          value: function() { return []; }
        },    
       
        _hideValueBounds:  {
          type: Boolean,
          value: true
        },
        
        _hoverDelay:{
          type: Number,
          value: 500
        },

        _currentValues: {
          type: Object,
          value: null
        },
      },
      
      // Computed bindings
      _hasNLines: function(currentValues, n) {
        // console.debug("[warp10-display-sparkline] _hasNLines", currentValues);
        if (!currentValues || !currentValues.yValues) {
          return false;
        }
        return (currentValues.yValues.length == n);
      },
      _hasMoreThanNLines: function(currentValues, n) {
        // console.debug("[warp10-display-sparkline] _hasMoreThanNLines", currentValues);
        if (!currentValues || !currentValues.yValues) { 
          return false;
        }
        return (currentValues.yValues.length > n);
      },

      _maxValue:  function(currentValues) {
        var max = - Number.MAX_VALUE;
        var maxIndex = -1;
        if (!currentValues || !currentValues.yValues  ) {
            return;
        }
        for (var i=0; i<currentValues.yValues.length; i++) {
          if (currentValues.yValues[i].yval > max) {
            max = currentValues.yValues[i].yval;
            maxIndex = i;
          }        
        }
        return max;
      },

      _minValue:  function(currentValues) {
        var min =  Number.MAX_VALUE;
        var minIndex = -1;
        if (!currentValues || !currentValues.yValues  ) {
            return;
        }
        for (var i=0; i<currentValues.yValues.length; i++) {
          if (currentValues.yValues[i].yval < min) {
            min = currentValues.yValues[i].yval;
            minIndex = i;
          }        
        }
        return min;
      },

      _getValue: function(currentValues, i) {
        if (!currentValues || !currentValues.yValues) { 
          return false;
        }
        return currentValues.yValues[i].yval;
      },

      _getName: function(currentValues,i) {
        if (!this.data || !this.data[0] || !this.data[0].params || !this.data[0].params[i] ) {
          return "";
        }
        var label = this.data[0].params[i].key;
        if (!label) {
          label = "Line "+i;
        }
        console.debug("[warp10-display-sparkline] _getName", label);
        return label;
      },


      _mouseEnter: function() {
        
        if (this._hideValueBounds) {
          this._initOpenValueBounds();
        } else {
          this._cancelCloseValueBounds();
        }
        
      },
      _mouseLeave: function() {
        if (this._hideValueBounds) {
          this._cancelOpenValueBounds();
        } else {
          this._initCloseValueBounds();
        }        
      },
      
      _openValueBounds: function() {
        // console.debug("[warp10-display-sparkline] _openValueBounds");
        this._hideValueBounds = false;
      },
      _initOpenValueBounds: function(){        
        // console.debug("[warp10-display-sparkline] _initOpenValueBounds");
        this.openTimeout = setTimeout(this._openValueBounds.bind(this), this._hoverDelay);
      },
      _cancelOpenValueBounds: function(){
        // console.debug("[warp10-display-sparkline] _cancelOpenValueBounds");
        clearTimeout(this.openTimeout);
      },

      _closeValueBounds: function() {
        // console.debug("[warp10-display-sparkline] _closeValueBounds");
        this._hideValueBounds = true;
      },       
      _initCloseValueBounds: function(){
        this.closeTimeout = setTimeout(this._closeValueBounds.bind(this), this._hoverDelay);
      },   
      _cancelCloseValueBounds: function(){
        clearTimeout(this.closeTimeout);
      },
      
    });
  </script>
</dom-module>